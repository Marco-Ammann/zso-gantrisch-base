<!-- src/app/features/adsz/adsz-detail/adsz-detail.page.html -->
<div class="bg-gradient-to-br from-slate-900 via-gray-900 to-slate-800 text-white min-h-screen">
  <!-- Header -->
  <div class="sticky top-0 z-40 backdrop-blur-lg bg-gray-900/80 border-b border-gray-700">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-3 items-center h-16">
        <!-- Back Button -->
        <div class="flex justify-start">
          <button (click)="back()"
            class="flex items-center gap-2 text-gray-300 hover:text-white transition-colors flex-shrink-0">
            <span class="material-symbols-outlined text-cp-orange text-base">arrow_back</span>
            <span class="hidden sm:inline text-xs font-normal text-cp-orange">Zurück zur Übersicht</span>
          </button>
        </div>

        <!-- Person Name -->
        <div class="flex justify-center">
          @if (person && !isNewPerson) {
          <h1 class="text-lg font-semibold truncate">
            {{ person.grunddaten.vorname }} {{ person.grunddaten.nachname }}
          </h1>
          } @else if (isNewPerson) {
          <h1 class="text-lg font-semibold">Neue Person erfassen</h1>
          }
        </div>

        <!-- Empty for balance -->
        <div class="flex justify-end"></div>
      </div>
    </div>
  </div>

  <!-- Avatar Section -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
    <div class="glass-card p-6 flex flex-col items-center">
      @if (person && !isNewPerson) {
      <div class="flex flex-col items-center">
        @if (person.photoUrl) {
        <img [src]="person.photoUrl" alt="Avatar" class="w-32 h-32 rounded-lg object-cover ring-4 ring-cp-orange/50" />
        } @else {
        <div
          class="w-32 h-32 rounded-lg bg-gradient-to-br from-gray-700 to-gray-800 flex items-center justify-center ring-4 ring-gray-600">
          <span class="text-white font-bold text-4xl">
            {{ getPersonInitials(person) }}
          </span>
        </div>
        }
      </div>

      <!-- Action Buttons -->
      <div class="mt-4 flex flex-wrap justify-center gap-2 action-buttons">
        <!-- PDF Button -->
        <button (click)="generatePDF()" class="glass-btn-neutral p-2 rounded-lg flex items-center justify-center"
          title="PDF generieren">
          <span class="material-symbols-outlined text-base">picture_as_pdf</span>
        </button>

        <!-- Edit Button - nur zeigen wenn nicht im Edit-Modus und nicht neue Person -->
        @if (showEditButton) {
        <button (click)="toggleEdit()" class="glass-btn-primary p-2 rounded-lg flex items-center justify-center"
          title="Bearbeiten">
          <span class="material-symbols-outlined text-base">edit</span>
        </button>
        }

        <!-- Delete Button - nur für Admins, nicht im Edit-Modus und nicht bei neuen Personen -->
        @if (canEdit && !isEditing && !isNewPerson) {
        <button (click)="openDeleteDialog()" [disabled]="isDeleting"
          class="glass-btn-danger p-2 rounded-lg flex items-center justify-center"
          title="Person löschen (unwiderruflich)">
          @if (isDeleting) {
          <div class="w-4 h-4 border-2 border-rose-300 border-t-transparent rounded-full animate-spin"></div>
          } @else {
          <span class="material-symbols-outlined text-base">delete</span>
          }
        </button>
        }

        <!-- Cancel Button - nur im Edit-Modus -->
        @if (showCancelButton) {
        <button (click)="cancel()" class="glass-btn-neutral p-2 rounded-lg flex items-center justify-center"
          title="Abbrechen">
          <span class="material-symbols-outlined text-base">close</span>
        </button>
        }


        <!-- Save Button - nur im Edit-Modus -->
        @if (showSaveButton) {
        <button (click)="save()" [disabled]="isSaving"
          class="glass-btn-primary p-2 rounded-lg flex items-center justify-center" title="Speichern">
          @if (isSaving) {
          <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
          } @else {
          <span class="material-symbols-outlined text-base">save</span>
          }
        </button>
        }
      </div>

      <!-- File Upload (nur im Edit-Modus) -->
      @if (isEditing) {
      <div class="mt-4 text-center">
        <input type="file" #fileInput accept="image/*" (change)="onFileSelected($event)" class="hidden" />
        <button (click)="fileInput.click()" [disabled]="uploading"
          class="text-sm text-cp-orange hover:text-cp-orange/80 flex items-center gap-1">
          @if (uploading) {
          <div class="w-3 h-3 border border-cp-orange border-t-transparent rounded-full animate-spin"></div>
          } @else {
          <span class="material-symbols-outlined text-xs">upload</span>
          }
          <span>Bild {{ person.photoUrl ? 'ändern' : 'hochladen' }}</span>
        </button>
      </div>
      }
      }
    </div>
  </div>

  <!-- Messages -->
  @if (errorMsg || successMsg) {
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-4">
    @if (errorMsg) {
    <div class="glass-card border-rose-500/20 bg-rose-500/10 p-4 mb-4">
      <div class="flex items-center gap-3">
        <span class="material-symbols-outlined text-rose-400">error</span>
        <p class="text-rose-300">{{ errorMsg }}</p>
      </div>
    </div>
    }

    @if (successMsg) {
    <div class="glass-card border-green-500/20 bg-green-500/10 p-4 mb-4">
      <div class="flex items-center gap-3">
        <span class="material-symbols-outlined text-green-400">check_circle</span>
        <p class="text-green-300">{{ successMsg }}</p>
      </div>
    </div>
    }
  </div>
  }

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-6">
    <!-- Content Grid - Responsive: 1 Spalte auf Mobile, 2 auf Desktop -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- ===== LINKE SPALTE ===== -->
      <div class="space-y-6">

        <!-- Grunddaten -->
        <div class="glass-card p-6">
          <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-cp-orange text-base">person</span>
            Grunddaten
          </h2>

          <form [formGroup]="grunddatenForm" class="space-y-4">
            <!-- Vorname & Nachname -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <zso-input-field label="Vorname" formControlName="vorname" [disabled]="!isEditing"
                [required]="true"></zso-input-field>

              <zso-input-field label="Nachname" formControlName="nachname" [disabled]="!isEditing"
                [required]="true"></zso-input-field>
            </div>

            <!-- Geburtsdatum & Grad -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="form-field">
                <label class="block text-sm font-medium text-gray-300 mb-1">
                  Geburtsdatum <span class="text-rose-400">*</span>
                </label>
                <input type="date" formControlName="geburtsdatum" [disabled]="!isEditing"
                  class="w-full rounded-lg bg-white/10 text-white p-3 border border-white/20 focus:border-cp-orange focus:ring-2 focus:ring-cp-orange/20 outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed" />
              </div>

              <div class="form-field">
                <label class="block text-sm font-medium text-gray-300 mb-1">
                  Grad <span class="text-rose-400">*</span>
                </label>
                <select formControlName="grad" [disabled]="!isEditing"
                  class="w-full rounded-lg bg-white/10 text-white p-3 border border-white/20 focus:border-cp-orange focus:ring-2 focus:ring-cp-orange/20 outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                  <option value="">Grad auswählen</option>
                  @for (grad of gradOptions; track grad) {
                  <option [value]="grad" class="bg-gray-800 text-white">{{ grad }}</option>
                  }
                </select>
              </div>
            </div>

            <!-- Funktion -->
            <div class="form-field">
              <label class="block text-sm font-medium text-gray-300 mb-1">
                Funktion <span class="text-rose-400">*</span>
              </label>
              <select formControlName="funktion" [disabled]="!isEditing"
                class="w-full rounded-lg bg-white/10 text-white p-3 border border-white/20 focus:border-cp-orange focus:ring-2 focus:ring-cp-orange/20 outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <option value="">Funktion auswählen</option>
                @for (funktion of funktionOptions; track funktion) {
                <option [value]="funktion" class="bg-gray-800 text-white">{{ funktion }}</option>
                }
              </select>
            </div>
          </form>
        </div>

        <!-- Kontaktdaten -->
        <div class="glass-card p-6">
          <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-cp-orange text-base">contact_mail</span>
            Kontaktdaten
          </h2>

          <form [formGroup]="kontaktdatenForm" class="space-y-4">
            <!-- Strasse -->
            <zso-input-field label="Strasse" formControlName="strasse" [disabled]="!isEditing"
              [required]="true"></zso-input-field>

            <!-- PLZ & Ort -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <zso-input-field label="PLZ" formControlName="plz" [disabled]="!isEditing"
                [required]="true"></zso-input-field>

              <zso-input-field label="Ort" formControlName="ort" [disabled]="!isEditing"
                [required]="true"></zso-input-field>
            </div>

            <!-- E-Mail -->
            <zso-input-field label="E-Mail" type="email" formControlName="email" [disabled]="!isEditing"
              [required]="true"></zso-input-field>

            <!-- Telefon Mobil -->
            <zso-input-field label="Telefon Mobil" type="tel" formControlName="telefonMobil" [disabled]="!isEditing"
              [required]="true"></zso-input-field>

            <!-- Telefon Festnetz -->
            <zso-input-field label="Telefon Festnetz" type="tel" formControlName="telefonFestnetz"
              [disabled]="!isEditing"></zso-input-field>

            <!-- Telefon Geschäftlich -->
            <zso-input-field label="Telefon Geschäftlich" type="tel" formControlName="telefonGeschaeftlich"
              [disabled]="!isEditing"></zso-input-field>
          </form>
        </div>

      </div>

      <!-- ===== RECHTE SPALTE ===== -->
      <div class="space-y-6">

        <!-- Zivilschutz -->
        <div class="glass-card p-6">
          <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-cp-orange text-base">shield</span>
            Zivilschutz
          </h2>

          <form [formGroup]="zivilschutzForm" class="space-y-4">
            <!-- Grundausbildung & Status -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <zso-input-field label="Grundausbildung (Jahr)" formControlName="grundausbildung" [disabled]="!isEditing"
                [required]="true"></zso-input-field>

              <div class="form-field">
                <label class="block text-sm font-medium text-gray-300 mb-1">
                  Status <span class="text-rose-400">*</span>
                </label>
                <select formControlName="status" [disabled]="!isEditing"
                  class="w-full rounded-lg bg-white/10 text-white p-3 border border-white/20 focus:border-cp-orange focus:ring-2 focus:ring-cp-orange/20 outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                  <option value="">Status auswählen</option>
                  @for (status of statusOptions; track status) {
                  <option [value]="status" class="bg-gray-800 text-white">{{ status }}</option>
                  }
                </select>
              </div>
            </div>

            <!-- Zug & Gruppe -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="form-field">
                <label class="block text-sm font-medium text-gray-300 mb-1">
                  Zug <span class="text-rose-400">*</span>
                </label>
                <select formControlName="zug" [disabled]="!isEditing"
                  class="w-full rounded-lg bg-white/10 text-white p-3 border border-white/20 focus:border-cp-orange focus:ring-2 focus:ring-cp-orange/20 outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                  <option value="">Zug auswählen</option>
                  @for (zug of zugOptions; track zug) {
                  <option [value]="zug" class="bg-gray-800 text-white">Zug {{ zug }}</option>
                  }
                </select>
              </div>

              <div class="form-field">
                <label class="block text-sm font-medium text-gray-300 mb-1">
                  Gruppe
                </label>
                <select formControlName="gruppe" [disabled]="!isEditing"
                  class="w-full rounded-lg bg-white/10 text-white p-3 border border-white/20 focus:border-cp-orange focus:ring-2 focus:ring-cp-orange/20 outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                  <option value="">Keine Gruppe</option>
                  @for (gruppe of gruppeOptions; track gruppe) {
                  <option [value]="gruppe" class="bg-gray-800 text-white">{{ gruppe }}</option>
                  }
                </select>
              </div>
            </div>

            <!-- Zusatzausbildungen -->
            <div class="form-field">
              <label class="block text-sm font-medium text-gray-300 mb-1">
                Zusatzausbildungen (kommagetrennt)
              </label>
              <textarea formControlName="zusatzausbildungen" [disabled]="!isEditing" rows="3"
                class="w-full rounded-lg bg-white/10 text-white p-3 border border-white/20 focus:border-cp-orange focus:ring-2 focus:ring-cp-orange/20 outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed resize-none"
                placeholder="Sanitäter, Kraftfahrer, ..."></textarea>
            </div>
          </form>
        </div>

        <!-- Persönliches -->
        <div class="glass-card p-6">
          <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-cp-orange text-base">person_outline</span>
            Persönliches
          </h2>

          <form [formGroup]="persoenlichesForm" class="space-y-4">
            <!-- Blutgruppe -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <zso-input-field label="Blutgruppe" formControlName="blutgruppe" [disabled]="!isEditing"
                placeholder="B+"></zso-input-field>
            </div>

            <!-- Allergien -->
            <div class="form-field">
              <label class="block text-sm font-medium text-gray-300 mb-1">
                Allergien (kommagetrennt)
              </label>
              <textarea formControlName="allergien" [disabled]="!isEditing" rows="2"
                class="w-full rounded-lg bg-white/10 text-white p-3 border border-white/20 focus:border-cp-orange focus:ring-2 focus:ring-cp-orange/20 outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed resize-none"
                placeholder="Nüsse, Pollen, ..."></textarea>
            </div>

            <!-- Essgewohnheiten -->
            <div class="form-field">
              <label class="block text-sm font-medium text-gray-300 mb-1">
                Essgewohnheiten (kommagetrennt)
              </label>
              <textarea formControlName="essgewohnheiten" [disabled]="!isEditing" rows="2"
                class="w-full rounded-lg bg-white/10 text-white p-3 border border-white/20 focus:border-cp-orange focus:ring-2 focus:ring-cp-orange/20 outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed resize-none"
                placeholder="Vegetarisch, Glutenfrei, ..."></textarea>
            </div>

            <!-- Sprachkenntnisse -->
            <div class="form-field">
              <label class="block text-sm font-medium text-gray-300 mb-1">
                Sprachkenntnisse (kommagetrennt)
              </label>
              <textarea formControlName="sprachkenntnisse" [disabled]="!isEditing" rows="2"
                class="w-full rounded-lg bg-white/10 text-white p-3 border border-white/20 focus:border-cp-orange focus:ring-2 focus:ring-cp-orange/20 outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed resize-none"
                placeholder="Deutsch, Englisch, Französisch, ..."></textarea>
            </div>

            <!-- Besonderheiten -->
            <div class="form-field">
              <label class="block text-sm font-medium text-gray-300 mb-1">
                Besonderheiten (kommagetrennt)
              </label>
              <textarea formControlName="besonderheiten" [disabled]="!isEditing" rows="3"
                class="w-full rounded-lg bg-white/10 text-white p-3 border border-white/20 focus:border-cp-orange focus:ring-2 focus:ring-cp-orange/20 outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed resize-none"
                placeholder="Brille, Hörhilfe, ..."></textarea>
            </div>
          </form>
        </div>

      </div>
    </div>

    <!-- Full-width Sections -->
    <div class="mt-6 space-y-6">

      <!-- Berufliches -->
      <div class="glass-card p-6">
        <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
          <span class="material-symbols-outlined text-cp-orange text-base">work</span>
          Berufliches
        </h2>

        <form [formGroup]="beruflichesForm" class="space-y-4">
          <!-- Erlernter & ausgeübter Beruf -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <zso-input-field label="Erlernter Beruf" formControlName="erlernterBeruf" [disabled]="!isEditing"
              [required]="true"></zso-input-field>

            <zso-input-field label="Ausgeübter Beruf" formControlName="ausgeubterBeruf" [disabled]="!isEditing"
              [required]="true"></zso-input-field>
          </div>

          <!-- Arbeitgeber -->
          <zso-input-field label="Arbeitgeber" formControlName="arbeitgeber" [disabled]="!isEditing"
            [required]="true"></zso-input-field>

          <!-- Zivile Spezialausbildung -->
          <zso-input-field label="Zivile Spezialausbildung" formControlName="zivileSpezialausbildung"
            [disabled]="!isEditing"></zso-input-field>

          <!-- Führerausweis -->
          <div class="form-field">
            <label class="block text-sm font-medium text-gray-300 mb-1">
              Führerausweis Kategorien (kommagetrennt)
            </label>
            <textarea formControlName="fuehrerausweisKategorie" [disabled]="!isEditing" rows="2"
              class="w-full rounded-lg bg-white/10 text-white p-3 border border-white/20 focus:border-cp-orange focus:ring-2 focus:ring-cp-orange/20 outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed resize-none"
              placeholder="B, C, D, BE, ..."></textarea>
          </div>
        </form>
      </div>

      <!-- Präferenzen -->
      <div class="glass-card p-6">
        <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
          <span class="material-symbols-outlined text-cp-orange text-base">settings</span>
          Präferenzen
        </h2>

        <form [formGroup]="preferencesForm" class="space-y-4">
          <!-- Kontaktmethode -->
          <div class="form-field">
            <label class="block text-sm font-medium text-gray-300 mb-3">
              Bevorzugte Kontaktmethode
            </label>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              @for (option of contactMethodOptions; track option.value) {
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" formControlName="contactMethod" [value]="option.value" [disabled]="!isEditing"
                  class="w-4 h-4 text-cp-orange border-gray-600 bg-gray-800 focus:ring-2 focus:ring-cp-orange/20" />
                <span class="text-sm text-gray-300">{{ option.label }}</span>
              </label>
              }
            </div>
          </div>

          <!-- E-Mail Benachrichtigungen -->
          <div class="form-field">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" formControlName="emailNotifications" [disabled]="!isEditing"
                class="w-4 h-4 text-cp-orange border-gray-600 bg-gray-800 rounded focus:ring-2 focus:ring-cp-orange/20" />
              <span class="text-sm text-gray-300">E-Mail Benachrichtigungen erhalten</span>
            </label>
          </div>
        </form>
      </div>

      <!-- Notfallkontakte -->
      @if (!isNewPerson) {
      <div class="glass-card p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-white flex items-center gap-2">
            <span class="material-symbols-outlined text-cp-orange text-base">contact_emergency</span>
            Notfallkontakte
          </h2>
          @if (canEdit) {
          <button (click)="openNotfallkontaktDialog()"
            class="glass-btn-primary px-3 py-1.5 rounded-lg text-sm flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">add</span>
            Hinzufügen
          </button>
          }
        </div>

        @if (notfallkontakte.length > 0) {
        <div class="space-y-3">
          @for (kontakt of notfallkontakte; track kontakt.id) {
          <div class="emergency-contact-card p-4 rounded-lg border border-rose-500/20 bg-rose-500/5">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <p class="font-medium text-white">{{ kontakt.name }}</p>
                <p class="text-sm text-gray-400">{{ kontakt.beziehung }}</p>
                <a [href]="'tel:' + kontakt.telefonnummer" class="text-sm text-cp-orange hover:text-cp-orange/80">
                  {{ kontakt.telefonnummer }}
                </a>
              </div>
              <div class="flex items-center gap-2">
                <!-- Priorität -->
                <span class="text-xs text-gray-200 bg-gray-700 px-2 py-1 rounded">
                  Priorität {{ kontakt.prioritaet }}
                </span>
                @if (canEdit) {
                <button (click)="editNotfallkontakt(kontakt)"
                  class="p-1 rounded text-gray-400 hover:text-cp-orange transition-colors" title="Bearbeiten">
                  <span class="material-symbols-outlined text-sm">edit</span>
                </button>
                <button (click)="deleteNotfallkontakt(kontakt.id)"
                  class="p-1 rounded text-gray-400 hover:text-rose-400 transition-colors" title="Löschen">
                  <span class="material-symbols-outlined text-sm">delete</span>
                </button>
                }
              </div>
            </div>
          </div>
          }
        </div>
        } @else {
        <div class="text-center py-8">
          <span class="material-symbols-outlined text-gray-500 text-4xl mb-2 block">contact_emergency</span>
          <p class="text-gray-400 text-sm mb-4">Keine Notfallkontakte erfasst</p>
          @if (canEdit) {
          <button (click)="openNotfallkontaktDialog()" class="glass-btn-primary px-4 py-2 rounded-lg">
            Ersten Kontakt hinzufügen
          </button>
          }
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>

<!-- Notfallkontakt Dialog -->
<zso-notfallkontakt-dialog [visible]="notfallkontaktDialogVisible" [kontakt]="editingKontakt"
  [personId]="person?.id || ''" (saved)="onNotfallkontaktSaved($event)" (closed)="onNotfallkontaktDialogClosed()">
</zso-notfallkontakt-dialog>

<!-- Delete Confirmation Dialog -->
<zso-confirmation-dialog [visible]="deleteDialogVisible" [title]="deleteDialogTitle" [message]="deleteDialogMessage"
  confirmText="Löschen" confirmType="danger" (confirmed)="onDeleteConfirmed($event)">
</zso-confirmation-dialog>

<!-- Upload Toast -->
@if (uploadMsg) {
<div class="fixed bottom-4 right-4 glass-card p-4 border-l-4 z-50 max-w-sm" [class.border-green-500]="!uploadError"
  [class.border-rose-500]="uploadError">
  <div class="flex items-center gap-3">
    @if (uploadError) {
    <span class="material-symbols-outlined text-rose-400">error</span>
    } @else {
    <span class="material-symbols-outlined text-green-400">check_circle</span>
    }
    <span class="text-white text-sm">{{ uploadMsg }}</span>
  </div>
</div>
}