<div class="max-w-7xl mx-auto px-4 py-10 space-y-6">

  <!-- Error Banner -->
  @if (errorMsg) {
    <div class="glass-card p-4 border-l-4 border-rose-500 bg-rose-500/10">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <span class="material-symbols-outlined text-rose-400 mr-2">error</span>
          <span class="text-rose-400 font-medium">{{ errorMsg }}</span>
        </div>
        <button (click)="errorMsg = null" class="text-rose-400 hover:text-rose-300">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
    </div>
  }

  <!-- Toolbar -->
  <div class="glass-card flex flex-wrap gap-4 items-center p-4 sm:p-5">
    <!-- Search -->
    <zso-input-field
        type="text" 
        label="Benutzer suchen"
        class="flex-grow sm:flex-none sm:w-72"
        [(ngModel)]="search"
        (ngModelChange)="onSearchChange($event)">
    </zso-input-field>

    <!-- Filters & Controls -->
    <div class="flex flex-wrap items-center gap-4 ml-auto">
      
      <!-- Block Filter Toggle -->
      <zso-checkbox 
        [(ngModel)]="showOnlyBlocked"
        label="Nur Gesperrte">
      </zso-checkbox>

      <!-- Sort Dropdown -->
      <div class="relative">
        <select
          [(ngModel)]="sortBy"
          (change)="onSortChange(sortBy)"
          class="sort-select peer">
          <option value="newest">Neueste zuerst</option>
          <option value="oldest">Ã„lteste zuerst</option>
          <option value="name">Nach Name</option>
          <option value="blocked">Gesperrte zuerst</option>
        </select>
        <span class="material-symbols-outlined pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 peer-focus:text-cp-orange transition-colors">
          arrow_drop_down
        </span>
      </div>

      <!-- Statistics -->
      <div class="text-sm text-white/80 hidden sm:block">
        <span>ğŸ“Š {{ stats.total }} Gesamt</span>
        <span class="text-amber-300 ml-2">â³ {{ stats.pending }}</span>
        <span class="text-rose-400 ml-2">ğŸš« {{ stats.blocked }}</span>
        <span class="text-green-400 ml-2">âœ… {{ stats.active }}</span>
      </div>

      <!-- Refresh Button -->
      <zso-button 
        type="neutral" 
        size="sm" 
        (click)="refresh()" 
        title="Aktualisieren"
        [loading]="isLoading">
        <span class="material-symbols-outlined text-base">refresh</span>
      </zso-button>
    </div>
  </div>

  <!-- Bulk Actions Bar -->
  @if (selectedUsersCount > 0) {
    <div class="glass-card p-4 flex items-center justify-between">
      <span class="text-white">{{ selectedUsersCount }} Benutzer ausgewÃ¤hlt</span>
      <div class="flex gap-2">
        <zso-button type="primary" size="sm" (click)="bulkApprove()">
          <span class="material-symbols-outlined text-sm mr-1">check</span>
          Alle genehmigen
        </zso-button>
        <zso-button type="danger" size="sm" (click)="bulkBlock()">
          <span class="material-symbols-outlined text-sm mr-1">block</span>
          Alle blockieren
        </zso-button>
        <zso-button type="neutral" size="sm" (click)="selectAll([], false)">
          Auswahl aufheben
        </zso-button>
      </div>
    </div>
  }

  <!-- Loading Indicator -->
  @if (isLoading) {
    <div class="glass-card p-4">
      <div class="flex items-center justify-center">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-cp-orange mr-3"></div>
        <span class="text-white">Lade Benutzerdaten...</span>
      </div>
    </div>
  }

  <!-- Users Content -->
  
  <!-- UNAPPROVED Users Section (Wartende/Nicht genehmigte) -->
  @if (filteredUsers.pending && filteredUsers.pending.length > 0) {
    <div class="space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold text-amber-400 flex items-center gap-2">
          <span class="material-symbols-outlined text-amber-300">hourglass_top</span>
          Wartende Benutzer ({{ filteredUsers.pending.length }})
        </h2>
        <div class="flex items-center gap-2">
          <zso-checkbox 
            [ngModel]="areAllUsersSelected(filteredUsers.pending)"
            (ngModelChange)="selectAll(filteredUsers.pending, $event)"
            label="Alle auswÃ¤hlen">
          </zso-checkbox>
        </div>
      </div>

      <div class="grid gap-4 grid-cols-[repeat(auto-fit,minmax(21rem,1fr))]">
        @for (user of filteredUsers.pending; track user.uid) {
          <div class="glass-card shimmer-once p-6 flex flex-col gap-4 relative"
               [ngClass]="{'ring-2 ring-cp-orange': isUserSelected(user.uid)}">

            <!-- Selection Checkbox -->
            <zso-checkbox 
              class="absolute top-4 right-4"
              [ngModel]="isUserSelected(user.uid)"
              (ngModelChange)="selectUser(user.uid, $event)"
              label="">
            </zso-checkbox>

            <!-- User Info -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 pr-8">
              <div>
                <h3 class="text-lg font-semibold text-white">
                  @if (isDemoUser(user.firstName)) {
                    <span class="demo-tag">(d)</span>
                  }
                  {{ getCleanFirstName(user.firstName) }} {{ user.lastName }}
                </h3>
                <p class="text-sm text-gray-300">{{ user.email }}</p>
                <p class="meta">
                  Registriert: {{ user.createdAt | date:'dd.MM.yyyy HH:mm' }}
                </p>
                <p class="meta">Rolle: {{ user.roles.join(', ') }}</p>
              </div>

              <zso-role-select 
                [roleOptions]="['user','admin']"
                [selected]="getUserRoles(user)"
                (selectedChange)="askRoleChange(user, $event)">
              </zso-role-select>
            </div>

            <!-- Actions -->
            <div class="flex flex-wrap gap-2 pt-2">
              <button title="Genehmigen" 
                      (click)="approve(user)" 
                      class="btn-approve glow-green"
                      [disabled]="isLoading">
                <span class="material-symbols-outlined text-lg">check</span>
              </button>
              <button title="Blockieren" 
                      (click)="toggleActive(user)" 
                      class="btn-block glow-red"
                      [disabled]="isLoading">
                <span class="material-symbols-outlined text-lg">block</span>
              </button>
              <button title="Details" 
                      (click)="details(user)" 
                      class="btn-neutral">
                <span class="material-symbols-outlined text-lg">person</span>
              </button>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- APPROVED Users Section (Genehmigte Benutzer) -->
  @if (filteredUsers.rest && filteredUsers.rest.length > 0) {
    <div class="space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold text-white">
          Genehmigte Benutzer ({{ filteredUsers.rest.length }})
        </h2>
        <div class="flex items-center gap-2">
          <zso-checkbox 
            [ngModel]="areAllUsersSelected(filteredUsers.rest)"
            (ngModelChange)="selectAll(filteredUsers.rest, $event)"
            label="Alle auswÃ¤hlen">
          </zso-checkbox>
        </div>
      </div>

      <div class="grid gap-4 grid-cols-[repeat(auto-fit,minmax(21rem,1fr))]">
        @for (user of filteredUsers.rest; track user.uid) {
          <div class="glass-card shimmer-once p-6 flex flex-col gap-4 relative"
               [ngClass]="{
                 'user-card--blocked': user.blocked,
                 'ring-2 ring-cp-orange': isUserSelected(user.uid)
               }">

            <!-- Selection Checkbox -->
            <zso-checkbox 
              class="absolute top-4 right-4"
              [ngModel]="isUserSelected(user.uid)"
              (ngModelChange)="selectUser(user.uid, $event)"
              label="">
            </zso-checkbox>

            <!-- User Info -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 pr-8">
              <div>
                <h3 class="text-lg font-semibold text-white">
                  @if (isDemoUser(user.firstName)) {
                    <span class="demo-tag">(d)</span>
                  }
                  {{ getCleanFirstName(user.firstName) }} {{ user.lastName }}
                  @if (user.blocked) {
                    <span class="badge badge--suspended">Gesperrt</span>
                  }
                </h3>
                <p class="text-sm text-gray-300">{{ user.email }}</p>
                <p class="meta">
                  Registriert: {{ user.createdAt | date:'dd.MM.yyyy' }}
                  @if (wasUserUpdated(user)) {
                    <span>â€¢ GeÃ¤ndert: {{ user.updatedAt | date:'dd.MM.yyyy' }}</span>
                  }
                </p>
                <p class="meta">Rolle: {{ user.roles.join(', ') }}</p>
                @if (user.lastLoginAt) {
                  <p class="meta">
                    Letzter Login: {{ user.lastLoginAt | date:'dd.MM.yyyy HH:mm' }}
                  </p>
                }
              </div>

              <zso-role-select 
                [roleOptions]="['user','admin']"
                [selected]="getUserRoles(user)"
                (selectedChange)="askRoleChange(user, $event)">
              </zso-role-select>
            </div>

            <!-- Actions -->
            <div class="flex flex-wrap gap-2 pt-2">
              @if (user.blocked) {
                <button title="Entsperren"
                        (click)="toggleActive(user)" 
                        class="btn-approve glow-green"
                        [disabled]="isLoading">
                  <span class="material-symbols-outlined text-lg">lock_open</span>
                </button>
              } @else {
                <button title="Blockieren"
                        (click)="toggleActive(user)" 
                        class="btn-block glow-red"
                        [disabled]="isLoading">
                  <span class="material-symbols-outlined text-lg">block</span>
                </button>
              }
              <button title="Details" 
                      (click)="details(user)" 
                      class="btn-neutral">
                <span class="material-symbols-outlined text-lg">person</span>
              </button>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Empty State -->
  @if ((!filteredUsers.pending || filteredUsers.pending.length === 0) && (!filteredUsers.rest || filteredUsers.rest.length === 0)) {
    <div class="glass-card p-12 text-center">
      <span class="material-symbols-outlined text-6xl text-gray-400 mb-4 block">search_off</span>
      <h3 class="text-xl font-medium text-white mb-2">Keine Benutzer gefunden</h3>
      <p class="text-gray-400">Versuche einen anderen Suchbegriff oder Ã¤ndere die Filter.</p>
    </div>
  }

  <!-- Confirmation Dialog -->
  <zso-confirmation-dialog></zso-confirmation-dialog>

</div>