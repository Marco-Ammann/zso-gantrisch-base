<div class="w-full max-w-full sm:max-w-7xl xl:max-w-8xl mx-auto px-4 md:px-6 lg:px-8 py-6 md:py-10 space-y-6">

  <!-- Error Banner -->
  @if (errorMsg) {
  <div class="glass-card p-4 border-l-4 border-rose-500 bg-rose-500/10">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <span class="material-symbols-outlined text-rose-400 mr-2">error</span>
        <span class="text-rose-400 font-medium">{{ errorMsg }}</span>
      </div>
      <button (click)="errorMsg = null" class="text-rose-400 hover:text-rose-300">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
  </div>
  }

  <!-- Page Header -->
  <div class="flex items-center gap-3">
    <span class="material-symbols-outlined text-2xl text-cp-orange">group</span>
    <h1 class="text-2xl font-bold tracking-tight">Benutzerverwaltung</h1>
  </div>

  <!-- Toolbar -->
  <div class="glass-card flex flex-wrap items-center gap-4 p-4 sm:p-5">
    <!-- Search -->
    <div class="relative flex-auto min-w-[12rem] sm:w-80">
      <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
      <input type="text" [(ngModel)]="search" (ngModelChange)="onSearchChange($event)" placeholder="Benutzer suchen"
        class="glass-input pl-10 w-full rounded-full bg-white/5 hover:bg-white/10 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cp-orange transition-colors py-2" />
    </div>

    <!-- Filters & Controls -->
    <div class="flex items-center flex-wrap gap-4 ml-auto">

      <!-- Block Filter -->
      <button type="button" class="pill underline-sweep flex items-center gap-1"
        [ngClass]="{'bg-rose-500/10': showOnlyBlocked}" (click)="showOnlyBlocked = !showOnlyBlocked">
        <span class="material-symbols-outlined text-sm">block</span>
        Gesperrt
      </button>

      <!-- Sort Dropdown -->
      <div class="relative">
        <select [(ngModel)]="sortBy" (change)="onSortChange(sortBy)" class="pill sort-select appearance-none pr-8">
          <option value="newest">Neueste zuerst</option>
          <option value="oldest">Ã„lteste zuerst</option>
          <option value="name">Nach Name</option>
          <option value="blocked">Gesperrte zuerst</option>
        </select>
        <span
          class="material-symbols-outlined pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 peer-focus:text-cp-orange transition-colors">
          expand_more
        </span>
      </div>

      <!-- Statistics -->
      <div class="text-sm text-white/80 hidden sm:block">
        <span>ğŸ“Š {{ stats.total }} Gesamt</span>
        <span class="text-amber-300 ml-2">â³ {{ stats.pending }}</span>
        <span class="text-rose-400 ml-2">ğŸš« {{ stats.blocked }}</span>
        <span class="text-green-400 ml-2">âœ… {{ stats.active }}</span>
      </div>

      <!-- Refresh Button -->
      <zso-button type="neutral" size="sm" (click)="refresh()" title="Aktualisieren" [loading]="isLoading">
        <span class="material-symbols-outlined text-base">refresh</span>
      </zso-button>
    </div>
  </div>

  <!-- Bulk Actions Bar -->
  @if (selectedUsersCount > 0) {
  <div class="glass-card p-3 sm:p-4 flex flex-col sm:flex-row items-start sm:items-center justify-between fixed bottom-0 left-0 right-0 sm:bottom-4 sm:left-1/2 sm:-translate-x-1/2 w-full max-w-full sm:max-w-7xl xl:max-w-8xl mx-auto z-40 shadow-lg rounded-t-lg sm:rounded-lg" [@slideBottom]>
    <div class="flex items-center justify-between w-full sm:w-auto mb-2 sm:mb-0">
      <span class="text-white text-sm sm:text-base font-medium">{{ selectedUsersCount }} {{ selectedUsersCount === 1 ? 'Benutzer' : 'Benutzer' }} ausgewÃ¤hlt</span>
      <button class="sm:hidden text-gray-300 hover:text-white" (click)="selectAll([], false)" aria-label="Auswahl aufheben">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="flex flex-wrap gap-2 w-full sm:w-auto justify-end">
      <zso-button type="primary" size="sm" class="flex-1 sm:flex-none" (click)="bulkApprove()">
        <span class="material-symbols-outlined text-sm sm:mr-1">check</span>
        <span class="hidden sm:inline">Alle genehmigen</span>
        <span class="sm:hidden">Genehmigen</span>
      </zso-button>
      <zso-button type="danger" size="sm" class="flex-1 sm:flex-none" (click)="bulkBlock()">
        <span class="material-symbols-outlined text-sm sm:mr-1">block</span>
        <span class="hidden sm:inline">Alle blockieren</span>
        <span class="sm:hidden">Blockieren</span>
      </zso-button>
      <zso-button type="neutral" size="sm" class="hidden sm:flex" (click)="selectAll([], false)">
        Auswahl aufheben
      </zso-button>
    </div>
  </div>
  
  <!-- Add bottom padding when bulk actions bar is visible on mobile -->
  <div class="h-16 sm:h-0"></div>
  }

  <!-- Loading Indicator -->
  @if (isLoading) {
  <div class="glass-card p-4">
    <div class="flex items-center justify-center">
      <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-cp-orange mr-3"></div>
      <span class="text-white">Lade Benutzerdaten...</span>
    </div>
  </div>
  }

  <!-- Users Content -->

  <!-- UNAPPROVED Users Section (Wartende/Nicht genehmigte) -->
  @if (filteredUsers.pending && filteredUsers.pending.length > 0) {
  <div class="space-y-4">

    <!-- Header -->
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-bold text-white flex items-center gap-2">
        <span class="material-symbols-outlined text-cp-orange">hourglass_top</span>
        Wartende Benutzer ({{ filteredUsers.pending.length }})
      </h2>
      <div class="flex items-center gap-2">
        <zso-checkbox [ngModel]="areAllUsersSelected(filteredUsers.pending)"
          (ngModelChange)="selectAll(filteredUsers.pending, $event)" label="Alle auswÃ¤hlen">
        </zso-checkbox>
      </div>
    </div>

    <!-- Users Grid -->
    <div class="grid gap-4 grid-cols-[repeat(auto-fit,minmax(19rem,1fr))]">
      @for (user of filteredUsers.pending; track user.uid) {
      

      <!-- User Card -->
      <div
        class="glass-card shimmer-once p-6 flex flex-col overflow-hidden gap-4 relative transition-all duration-200 hover:shadow-xl hover:bg-white/5"
        [ngClass]="{'ring-2 ring-cp-orange': isUserSelected(user.uid), 'ring-2 ring-teal-400': isCurrentUser(user.uid)}">

        <!-- Selection Checkbox -->
        <zso-checkbox class="absolute top-4 right-4" [ngModel]="isUserSelected(user.uid)"
          (ngModelChange)="selectUser(user.uid, $event)" label="">
        </zso-checkbox>

        <!-- Avatar -->
        <div class="flex items-center gap-4">
          <ng-container *ngIf="user.photoUrl || user.photoURL; else placeholder">
            <img [src]="user.photoUrl || user.photoURL" alt="Avatar"
              class="h-12 w-12 rounded-full object-cover ring-1 ring-white/20" />
          </ng-container>
          <ng-template #placeholder>
            <div class="h-12 w-12 rounded-full bg-white/10 flex items-center justify-center ring-1 ring-white/20">
              <span class="material-symbols-outlined text-lg text-gray-400">person</span>
            </div>
          </ng-template>
        </div>
        <!-- User Info -->
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4 pr-4 min-w-0 flex-shrink">
          <div>
            <h3 class="text-lg font-semibold text-white break-words">
              @if (isDemoUser(user.firstName)) {
              <span class="demo-tag">(d)</span>
              }
              {{ getCleanFirstName(user.firstName) }} {{ user.lastName }}
            </h3>
            <p class="text-sm text-gray-300 break-all whitespace-normal">{{ user.email }}</p>
            <p class="meta">
              Registriert: {{ user.createdAt | date:'dd.MM.yyyy HH:mm' }}
            </p>
            <p class="meta">Rolle: {{ user.roles.join(', ') }}</p>
          </div>

          <zso-role-select [roleOptions]="['user','admin']" [selected]="getUserRoles(user)"
            (selectedChange)="askRoleChange(user, $event)">
          </zso-role-select>
        </div>

        <!-- Actions -->
        <div class="flex flex-wrap gap-2 pt-2">
          <button title="Genehmigen" (click)="approve(user)" class="btn-approve glow-green" [disabled]="isLoading">
            <span class="material-symbols-outlined text-lg">check</span>
          </button>
          <button title="Blockieren" (click)="toggleActive(user)" class="btn-block glow-red" [disabled]="isLoading">
            <span class="material-symbols-outlined text-lg">block</span>
          </button>
          <button title="Details" (click)="details(user)" class="btn-neutral">
            <span class="material-symbols-outlined text-lg">person</span>
          </button>
        </div>
      </div>
      }
    </div>
  </div>
  }

  <!-- APPROVED Users Section (Genehmigte Benutzer) -->
  @if (filteredUsers.rest && filteredUsers.rest.length > 0) {
  <div class="space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-bold text-white">
        Genehmigte Benutzer ({{ filteredUsers.rest.length }})
      </h2>
      <div class="flex items-center gap-2">
        <zso-checkbox [ngModel]="areAllUsersSelected(filteredUsers.rest)"
          (ngModelChange)="selectAll(filteredUsers.rest, $event)" label="Alle auswÃ¤hlen">
        </zso-checkbox>
      </div>
    </div>

    <div class="grid gap-4 grid-cols-[repeat(auto-fit,minmax(19rem,1fr))]">
      @for (user of filteredUsers.rest; track user.uid) {
      

      <div
        class="glass-card shimmer-once p-6 flex flex-col overflow-hidden gap-4 relative transition-all duration-200 hover:shadow-xl hover:bg-white/5"
        [ngClass]="{
                 'user-card--blocked': user.blocked,
                 'ring-2 ring-cp-orange': isUserSelected(user.uid), 'ring-2 ring-teal-400': isCurrentUser(user.uid)
               }">

        <!-- Selection Checkbox -->
        <zso-checkbox class="absolute top-4 right-4" [ngModel]="isUserSelected(user.uid)"
          (ngModelChange)="selectUser(user.uid, $event)" label="">
        </zso-checkbox>

        <!-- Avatar -->
        <div class="flex items-center gap-4">
          <ng-container *ngIf="user.photoUrl || user.photoURL; else placeholder">
            <img [src]="user.photoUrl || user.photoURL" alt="Avatar"
              class="h-12 w-12 rounded-full object-cover ring-1 ring-white/20" />
          </ng-container>
          <ng-template #placeholder>
            <div class="h-12 w-12 rounded-full bg-white/10 flex items-center justify-center ring-1 ring-white/20">
              <span class="material-symbols-outlined text-lg text-gray-400">person</span>
            </div>
          </ng-template>
        </div>
        <!-- User Info -->
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4 pr-4 min-w-0 flex-shrink">
          <div>
            <h3 class="text-lg font-semibold text-white break-words">
              @if (isDemoUser(user.firstName)) {
              <span class="demo-tag">(d)</span>
              }
              {{ getCleanFirstName(user.firstName) }} {{ user.lastName }}
              @if (user.blocked) {
              <span class="badge badge--suspended">Gesperrt</span>
              }
            </h3>
            <p class="text-sm text-gray-300 break-all whitespace-normal">{{ user.email }}</p>
            <p class="meta">
              Registriert: {{ user.createdAt | date:'dd.MM.yyyy' }}
              @if (wasUserUpdated(user)) {
              <span>â€¢ GeÃ¤ndert: {{ user.updatedAt | date:'dd.MM.yyyy' }}</span>
              }
            </p>
            <p class="meta">Rolle: {{ user.roles.join(', ') }}</p>
            @if (user.lastLoginAt) {
            <p class="meta">
              Letzter Login: {{ user.lastLoginAt | date:'dd.MM.yyyy HH:mm' }}
            </p>
            }
          </div>

          <zso-role-select [roleOptions]="['user','admin']" [selected]="getUserRoles(user)"
            (selectedChange)="askRoleChange(user, $event)">
          </zso-role-select>
        </div>

        <!-- Actions -->
        <div class="flex flex-wrap gap-2 pt-2">
          @if (user.blocked) {
          <button title="Entsperren" (click)="toggleActive(user)" class="btn-approve glow-green" [disabled]="isLoading">
            <span class="material-symbols-outlined text-lg">lock_open</span>
          </button>
          } @else {
           <button title="Genehmigung zurÃ¼ckziehen" (click)="unapprove(user)" class="btn-neutral" [disabled]="isLoading">
             <span class="material-symbols-outlined text-lg">backspace</span>
           </button>
           <button title="Blockieren" (click)="toggleActive(user)" class="btn-block glow-red" [disabled]="isLoading">
             <span class="material-symbols-outlined text-lg">block</span>
           </button>
          }
          <button title="Details" (click)="details(user)" class="btn-neutral">
            <span class="material-symbols-outlined text-lg">person</span>
          </button>
        </div>
      </div>
      }
    </div>
  </div>
  }

  <!-- Empty State -->
  @if ((!filteredUsers.pending || filteredUsers.pending.length === 0) && (!filteredUsers.rest ||
  filteredUsers.rest.length === 0)) {
  <div class="glass-card p-12 text-center">
    <span class="material-symbols-outlined text-6xl text-gray-400 mb-4 block">search_off</span>
    <h3 class="text-xl font-medium text-white mb-2">Keine Benutzer gefunden</h3>
    <p class="text-gray-400">Versuche einen anderen Suchbegriff oder Ã¤ndere die Filter.</p>
  </div>
  }

  <!-- Confirmation Dialog -->
  <zso-confirmation-dialog></zso-confirmation-dialog>

</div>